(function(){
    'use strict';

    var jsonfile = {
        "voices": [
            {
                "char": "N",
                "voice": "margauxhappy8k"
            },
            {
                "char": "T",
                "voice": "antoine8k"
            },
            {
                "char": "PI",
                "voice": "bruno8k"
            },
            {
                "char": "CH",
                "voice": "claire8k"
            },
            {
                "char": "LI",
                "voice": "julie8k"
            },
            {
                "char": "CHE",
                "voice": "antoinesad8k"
            },
            {
                "char": "VA",
                "voice": "manon8k"
            },
            {
                "char": "CO",
                "voice": "margauxsad8k"
            },
            {
                "char": "MO",
                "voice": "alice8k"
            }
        ],

        "dialog": [
            {
                "page": "1",
                "texts": [
                    {
                        "char": "T",
                        "text": "Hey batard, c'est toi qui m'a chié sur la gueule ? zzbraa"
                    },
                    {
                        "char": "N",
                        "text": "Comme tous les matin, la petite taupe sortit de terre son museau pointu. Et voici ce qui arriva. C'etait rond et marron, aussi long qu'une saucisse, et le plus horrible fut que ca lui tomba exactement sur la tête, sploutsch !"
                    },
                    {
                        "char": "T",
                        "text": "J'vous aime putain !"
                    },
                ]
            },

            {
                "page": "2",
                "texts": [
                    {
                        "char": "T",
                        "text": "Mais c'est degoutant"
                    },
                    {
                        "char": "N",
                        "text": "rouspeta la petite taupe"
                    },
                    {
                        "char": "T",
                        "text": "qui a ose me faire ca sur la tête ?"
                    },
                    {
                        "char": "N",
                        "text": "Evidemment, personne ne repondit"
                    }
                ]
            },

            {
                "page": "3",
                "texts": [
                    {
                        "char": "T",
                        "text": "Dis donc le pigeon"
                    },
                    {
                        "char": "N",
                        "text": "glapit-elle"
                    },
                    {
                        "char": "T",
                        "text": "est-ce toi qui m'a fait sur la tête ?"
                    }
                ]
            },

            {
                "page": "4",
                "texts": [
                    {
                        "char": "PI",
                        "text": "Moi ? Mais non voyons ! Moi, je fais comme ca !"
                    },
                    {
                        "char": "N",
                        "text": "et splatsch ! un petit pate laiteux vint s'ecraser juste devant la petite taupe, et moucheta de blanc son pied droit"
                    }
                ]
            },

            {
                "page": "5",
                "texts": [
                    {
                        "char": "T",
                        "text": "He le cheval, est-ce toi qui m'as fait sur la tête ?"
                    }
                ]
            },

            {
                "page": "6",
                "texts": [
                    {
                        "char": "CH",
                        "text": "Moi ? Mais non voyons ! Moi, je fais comme ca !"
                    },
                    {
                        "char": "N",
                        "text": "Et pouf, il bombarda l'herbe d'un bon, gros, crottin. La petite taupe fut drôlement impressionnée"
                    }
                ]
            },

            {
                "page": "7",
                "texts": [
                    {
                        "char": "T",
                        "text": "Hola ! Le lievre ! est-ce toi qui m'as fait sur la tête ?"
                    }
                ]
            },

            {
                "page": "8",
                "texts": [
                    {
                        "char": "LI",
                        "text": "Moi ? Mais non voyons ! Moi, je fais comme ca !"
                    },
                    {
                        "char": "N",
                        "text": "Et zzbraa ! Cinquante petits haricots tout ronds petardèrent aux oreilles de la petite taupe"
                    }
                ]
            },

            {
                "page": "9",
                "texts": [
                    {
                        "char": "T",
                        "text": "Dis-moi la chèvre ! est-ce toi qui m'as fait sur la tête ?"
                    }
                ]
            },

            {
                "page": "10",
                "texts": [
                    {
                        "char": "CHE",
                        "text": "Moi ? Mais non voyons ! Moi, je fais comme ca !"
                    },
                    {
                        "char": "N",
                        "text": "Et clang di clang di clang ! Un paquet de petits berlingots couleur chocolat degringolerent sur la prairie. La petite taupe les trouva fort gracieux, ma foi"
                    }
                ]
            },

            {
                "page": "11",
                "texts": [
                    {
                        "char": "T",
                        "text": "Reponds, la vache ! est-ce toi qui m'as fait sur la tête ?"
                    }
                ]
            },

            {
                "page": "12",
                "texts": [
                    {
                        "char": "VA",
                        "text": "Moi ? Mais non voyons ! Moi, je fais comme ca !"
                    },
                    {
                        "char": "N",
                        "text": "Et ssplaoutsch ! Une enorme bouse verdatre s'ecrabouilla mollement sur le sol. Diable ! pensa-t-elle, c'est une chance que cette chose-la ne me soit pas tombee sur la tête !"
                    }
                ]
            },

            {
                "page": "13",
                "texts": [
                    {
                        "char": "T",
                        "text": "Cochon, écoute-moi ! est-ce toi qui m'as fait sur la tête ?"
                    }
                ]
            },

            {
                "page": "14",
                "texts": [
                    {
                        "char": "CO",
                        "text": "Moi ? Mais non voyons ! Moi, je fais comme ca !"
                    },
                    {
                        "char": "CO",
                        "text": "Et vlouf ! il envoya un petit tas brun et mou derriere lui. Beurk ! La petite taupe se boucha bien vite le nez."
                    }
                ]
            },

            {
                "page": "15",
                "texts": [
                    {
                        "char": "T",
                        "text": "Hep, vous ! Est-ce que"
                    },
                    {
                        "char": "N",
                        "text": "Commenca la petite taupe. Mais il n'y avait la que deux grosses mouches noires, qui faisaient bombance."
                    },
                    {
                        "char": "T",
                        "text": "Enfin !"
                    },
                    {
                        "char": "N",
                        "text": "pensa-t-elle"
                    },
                    {
                        "char": "T",
                        "text": "Voila des gens qui vont pouvoir me renseigner."
                    },
                    {
                        "char": "N",
                        "text": "Et elle chuchota:"
                    },
                    {
                        "char": "T",
                        "text": "Qui a bien pu me faire sur la tête, mesdames ?"
                    }
                ]
            },

            {
                "page": "16",
                "texts": [
                    {
                        "char": "N",
                        "text": "Les deux mouches n'hesitèrent pas longtemps."
                    },
                    {
                        "char": "MO",
                        "text": "Aucun doute, ma chère, c'est un chien."
                    }
                ]
            },

            {
                "page": "17",
                "texts": [
                    {
                        "char": "N",
                        "text": "Cette fois, la taupe le tenait, le gros malpropre qui avait fait sur sa tête"
                    }
                ]
            },

            {
                "page": "18",
                "texts": [
                    {
                        "char": "N",
                        "text": "Jean Henri, le chien du boucher ! Sa vengeance allait être terrible !"
                    }
                ]
            },

            {
                "page": "19",
                "texts": [
                    {
                        "char": "N",
                        "text": "D'un bond, la petite taupe sauta sur la niche de Jean Henri...."
                    }
                ]
            },

            {
                "page": "20",
                "texts": [
                    {
                        "char": "N",
                        "text": "Voila ! Justice était faite !"
                    },
                    {
                        "char": "N",
                        "text": "Radieuse, la petite taupe, s'enfonca a nouveau dans les entrailles de la terre, la ou, assurément, personne au monde ne pouvait lui faire sur la tête."
                    }
                ]
            }
        ]
    };
    
    var obj = jsonfile.dialog;
    var address = 'http://vaas.acapela-group.com/Services/Streamer.ogg?req_voice=';
    var text = '&req_text=';
    var log = '&cl_login=EVAL_VAAS&cl_app=EVAL_2267118&cl_pwd=rqdlg7j0';
    var toSay;
    
    function playSound() {
        var a = new Audio('http://vaas.acapela-group.com/Services/Streamer.ogg?req_voice=antoine8k&req_text=hello world&cl_login=EVAL_VAAS&cl_app=EVAL_2267118&cl_pwd=rqdlg7j0');
        a.play();
    }

    function playChosedSound(page, mainCallback) {

        if( Sounds.deactive ){
            console.log('sound deactivated');
            console.log('blabla');
            setTimeout(function(){
                return mainCallback();
            }, 1000);
            return;
        }
        
        for (var i = 0; i < obj.length; i++){
            // look for the entry with a matching `code` value
            if (obj[i].page == page){
                toSay = obj[i].texts;
            }
        }

        var plays = [];

        for (var i = 0; i < toSay.length; i++){

            (function(j){
                plays.push(function(cb){
                    console.log(j);
                    var voice = toSay[j].char;
                    var blabla = toSay[j].text;
                    var listvoice = jsonfile.voices;
                    var toHear;

                    for (var i = 0; i < listvoice.length; i++){
                        // look for the entry with a matching `code` value
                        if (listvoice[i].char == voice){
                            toHear = listvoice[i].voice;
                        }
                    }
                    var a = new Audio(address + toHear +  text + blabla + log);
                    //var a = new Audio('http://vaas.acapela-group.com/Services/Streamer.ogg?req_voice=alice8k&req_text=Mais c"est degoutant&cl_login=EVAL_VAAS&cl_app=EVAL_2267118&cl_pwd=rqdlg7j0');
                    a.addEventListener("ended", function() { cb(); }, true);
                    a.play();
                });
            })(i);

        }

        async.series(plays,function(error){
            mainCallback();
        });
    }

    function ask(question, match, errorMessage, cb){
        if (annyang){
            // Let's define our first command. First the text we expect, and then the function it should call

            annyang.setLanguage('fr-FR');

            var commands = {};
            commands[match] = function () {
                annyang.abort();
                return cb(true);
            };

            // Add our commands to annyang
            annyang.addCommands(commands);

            var a = new Audio(address + "margauxhappy8k" +  text + question + log);
            a.play();
            
            // Start listening. You can call this here, or attach this call to an event, button, etc.
            annyang.start();
            annyang.debug(true);
            annyang.addCallback('resultNoMatch', function(){
                Sounds.play(errorMessage);
            });
        }
    }
    
    function play(sentence, cb){
        var a = new Audio(address + "margauxhappy8k" +  text + sentence + log);
        a.addEventListener("ended", function(){
            cb();
        }, true);
        a.play();
    }
    
    // Export library
    window.Sounds = {
        playSound: playSound,
        playChosedSound: playChosedSound,
        deactive : false,
        ask: ask,
        play: play
    }
    
})();